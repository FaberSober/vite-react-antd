import { create } from 'zustand';
import { devtools } from 'zustand/middleware';
import { DynItem } from '../../dnd/types';
import { generateId } from '@/utils';

interface FaFormState {
  formItems: DynItem[];
  // 添加表单项
  addFormItem: (type: 'input' | 'row') => void;
  // 删除表单项
  removeFormItem: (id: string) => void;
  // 更新表单项
  updateFormItem: (id: string, item: Partial<DynItem>) => void;
  // 添加子项到行容器
  addChildToRow: (rowId: string, type: 'input' | 'row') => void;
  // 从行中删除子项
  removeChildFromRow: (rowId: string, childId: string) => void;
  // 重新排序表单项
  reorderFormItems: (items: DynItem[]) => void;
  // 重新排序行内的子项
  reorderRowChildren: (rowId: string, children: DynItem[]) => void;
  // 将子项从一个行移动到另一个行
  moveChildBetweenRows: (sourceRowId: string, targetRowId: string, childId: string) => void;
  // 将子项从行移动到主表单
  moveChildFromRowToForm: (rowId: string, childId: string) => void;
  // 将主表单项目移动到行内
  moveFormItemToRow: (formItemId: string, rowId: string) => void;
  // 清空表单
  clearFormItems: () => void;
}

export const useFaFormStore = create<FaFormState>()(
  devtools<FaFormState>(
    (set, get) => ({
      formItems: [],

      addFormItem: (type) =>
        set((state) => ({
          formItems: [...state.formItems, { id: generateId(), type, children: [] }],
        })),

  removeFormItem: (id) =>
    set((state) => ({
      formItems: state.formItems.filter((item) => item.id !== id),
    })),

  updateFormItem: (id, updates) =>
    set((state) => ({
      formItems: state.formItems.map((item) =>
        item.id === id ? { ...item, ...updates } : item
      ),
    })),

  addChildToRow: (rowId, type) =>
    set((state) => ({
      formItems: state.formItems.map((item) =>
        item.id === rowId && item.type === 'row'
          ? {
              ...item,
              children: [
                ...(item.children || []),
                { id: generateId(), type, children: [] },
              ],
            }
          : item
      ),
    })),

  removeChildFromRow: (rowId, childId) =>
    set((state) => ({
      formItems: state.formItems.map((item) =>
        item.id === rowId && item.type === 'row'
          ? {
              ...item,
              children: (item.children || []).filter((child) => child.id !== childId),
            }
          : item
      ),
    })),

  reorderFormItems: (items) =>
    set(() => ({
      formItems: items,
    })),

  reorderRowChildren: (rowId, children) =>
    set((state) => ({
      formItems: state.formItems.map((item) =>
        item.id === rowId && item.type === 'row'
          ? { ...item, children }
          : item
      ),
    })),

  moveChildBetweenRows: (sourceRowId, targetRowId, childId) =>
    set((state) => ({
      formItems: state.formItems.map((item) => {
        // 从源行删除子项
        if (item.id === sourceRowId && item.type === 'row') {
          return {
            ...item,
            children: (item.children || []).filter((child) => child.id !== childId),
          };
        }
        // 到目标行添加子项
        if (item.id === targetRowId && item.type === 'row') {
          const childToMove = state.formItems
            .find((sourceItem) => sourceItem.id === sourceRowId && sourceItem.type === 'row')
            ?.children?.find((child) => child.id === childId);

          if (childToMove) {
            return {
              ...item,
              children: [...(item.children || []), childToMove],
            };
          }
        }
        return item;
      }),
    })),

  moveChildFromRowToForm: (rowId, childId) =>
    set((state) => ({
      formItems: state.formItems.map((item) => {
        // 从源行删除子项
        if (item.id === rowId && item.type === 'row') {
          const childToMove = item.children?.find((child) => child.id === childId);
          if (childToMove) {
            // 返回修改后的行（删除子项）
            const newItem = {
              ...item,
              children: (item.children || []).filter((child) => child.id !== childId),
            };
            return newItem;
          }
        }
        return item;
      }).concat(
        // 查找要移动的子项
        state.formItems
          .find((item) => item.id === rowId && item.type === 'row')
          ?.children?.find((child) => child.id === childId) || null
      ).filter((item): item is DynItem => item !== null),
    })),

  moveFormItemToRow: (formItemId, rowId) =>
    set((state) => {
      // 查找要移动的表单项
      const itemToMove = state.formItems.find((item) => item.id === formItemId);
      if (!itemToMove) return state;

      return {
        formItems: state.formItems
          .filter((item) => item.id !== formItemId) // 从表单顶层移除
          .map((item) => {
            // 添加到目标行
            if (item.id === rowId && item.type === 'row') {
              return {
                ...item,
                children: [...(item.children || []), itemToMove],
              };
            }
            return item;
          }),
      };
    }),

  clearFormItems: () =>
    set(() => ({
      formItems: [],
    })),
    }),
    { name: 'FaFormStore' }
  )
);
